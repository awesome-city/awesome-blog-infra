name: Trigger test
on:
  push:
    branches:
      - 'main'

jobs:
  template-version:
    runs-on: ubuntu-latest
    outputs:
      template-version: ${{ steps.TemplateVersion.outputs.template-version }}
    steps:
      - id: TemplateVersion
        name: TemplateVersion
        run: echo "template-version=v$(date +"%Y%m%d%H%M")" >> "$GITHUB_OUTPUT"

  lint:
    uses: ./.github/workflows/_lint.yaml

  upload:
    needs:
      - lint
      - template-version
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        template-name:
          - 'awesome-blog-s3.template.yaml'
          - 'awesome-blog-stateful.template.yaml'
    env:
      AWS_REGION: ap-northeast-1
      AWS_CFN_TEMPLATE_BUCKET: awesome-cmn-cfn
      TEMPLATE_VERSION: ${{ needs.template-version.outputs.template-version}}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ap-northeast-1

      - id: upload
        name: Upload Cloudformation Template
        run: |
          OUTPUT_TEMPLATE_FILE="./cfn/out/${{ matrix.template-name }}"
          S3_BUCKET="awesome-cmn-cfn"
          S3_BUCKET_PREFIX="${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}/${TEMPLATE_VERSION}"

          aws cloudformation package \
            --template-file ./cfn/template/${{ matrix.template-name }} \
            --s3-bucket "${S3_BUCKET}" \
            --s3-prefix "${S3_BUCKET_PREFIX}" \
            --output-template-file "${OUTPUT_TEMPLATE_FILE}"

          {
            echo "output-template-file=${OUTPUT_TEMPLATE_FILE}"
            echo "s3-bucket=${S3_BUCKET}"
            echo "s3-bucket-prefix=${S3_BUCKET_PREFIX}"
          } >> "$GITHUB_OUTPUT"

      - id: upload-api-spec
        name: Upload OpenAPI Specification
        working-directory: ./openapi
        run: |
          for env in dev stg prd
          do
            for name in `find . -type f -name '*.yaml'`; do sed -e "s/awesome-blog-dev/awesome-blog-$env/g" $name > ./$env/$name; done
          done

          aws s3 cp \
            . \
            s3://${{ steps.upload.outputs.s3-bucket }}/${{ steps.upload.outputs.s3-bucket-prefix }}/openapi/ \
            --recursive

      - name: Validate
        run: |
          aws cloudformation validate-template \
            --template-body file://./${{ steps.upload.outputs.output-template-file }}

      - name: Upload Packaged Template
        run: |
          aws s3 cp \
            ${{ steps.upload.outputs.output-template-file }} \
            s3://${{ steps.upload.outputs.s3-bucket }}/${{ steps.upload.outputs.s3-bucket-prefix }}/

  tag:
    needs:
      - upload
      - template-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.OWNER_PAT }}

      - id: Tag
        name: Push Tag
        env:
          TEMPLATE_VERSION: ${{ needs.template-version.outputs.template-version}}
        run: |
          echo "TEMPLATE_VERSION=${TEMPLATE_VERSION}"
          git tag "${TEMPLATE_VERSION}"
          git push origin "${TEMPLATE_VERSION}"
          echo "template-version=${TEMPLATE_VERSION}" >> "$GITHUB_OUTPUT"


